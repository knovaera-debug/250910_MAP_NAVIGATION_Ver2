<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>実車評価支援ツール Ver5.4</title>
<link rel="stylesheet" href="leaflet.css" />
<style>
  html,body{height:100%;margin:0}
  #map{position:fixed; inset:0; background:#f2f2f2; z-index:0;}
  #panel{
    position:fixed; left:10px; top:calc(10px + env(safe-area-inset-top));
    z-index:2147483000; background:#fff; padding:10px 12px; border-radius:12px;
    box-shadow:0 6px 24px rgba(0,0,0,.18);
    font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans JP",sans-serif;
    min-width:300px; max-width:min(94vw,560px);
    transition: transform 0.3s ease-in-out;
  }
  .panel-hidden { transform: translateX(-110%); }
  #panel h1{margin:0 0 8px;font-size:15px;font-weight:700}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin:6px 0}
  .small{font-size:11px;color:#555}
  button{padding:10px 14px; min-height:40px; border-radius:12px;
    cursor:pointer; border:1px solid #ddd; background:#fff;}
  #start{background:#16a34a;color:#fff;border-color:#16a34a}
  #recenter{background:#0ea5e9;color:#fff;border-color:#0ea5e9}
  #cp{background:#f59e0b;color:#fff;border-color:#f59e0b}
  #saveGpx{background:#6366f1;color:#fff;border-color:#6366f1}
  #fabStop{position:fixed; right:calc(12px + env(safe-area-inset-right));
    bottom:calc(12px + env(safe-area-inset-bottom));
    z-index:2147483200; display:none; width:84px;height:84px;border-radius:50%;
    box-shadow:0 12px 36px rgba(0,0,0,.28);
    border:none; background:#ef4444;color:#fff;font-size:16px;font-weight:700;}
  #recBadge{position:fixed; right:12px; top:calc(12px + env(safe-area-inset-top));
    z-index:2147483200; display:none; align-items:center; gap:6px;
    background:rgba(239,68,68,.95); color:#fff; padding:6px 10px; border-radius:9999px;
    box-shadow:0 6px 24px rgba(0,0,0,.18); font-size:12px}
  .dot{width:10px;height:10px;border-radius:50%;background:#fff;animation:blink 1s infinite}
  @keyframes blink{0%,60%{opacity:1}61%,100%{opacity:.25}}
  #toast{position:fixed; left:50%; bottom:calc(78px + env(safe-area-inset-bottom));
    transform:translateX(-50%); z-index:2147483100; display:none;
    max-width:min(92vw,560px); background:rgba(0,0,0,.85); color:#fff;
    padding:10px 14px; border-radius:12px; box-shadow:0 6px 24px rgba(0,0,0,.35);
    font-size:14px}
  #fname{max-width:200px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .counts{font-size:11px;color:#334155;background:#f1f5f9;border-radius:9999px;padding:2px 8px}
</style>
</head>
<body>
<div id="map"></div>

<div id="panel">
  <h1>実車評価支援ツール Ver5.4</h1>

  <div class="row">
    <input
      type="file"
      id="file"
      accept=".kml,.kmz,application/vnd.google-earth.kmz,application/vnd.google-earth.kml+xml,application/zip,application/x-zip-compressed,application/octet-stream"
      multiple
    />
    <select id="datasetSelect" class="grow">
      <option value="" disabled selected>（読み込んだルート／ポイントを選択）</option>
    </select>
    <span id="fname" class="small"></span>
  </div>

  <div class="row">
    <button id="start">追跡開始</button>
    <button id="recenter">現在地へ</button>
    <button id="cp" disabled>チェックポイント</button>
    <span id="counts" class="counts"></span>
  </div>

  <div class="row">
    <label><input type="checkbox" id="keepCentered" checked />自車を常に中心</label>
    <label style="margin-left:10px">向き:</label>
    <label><input type="radio" name="orient" value="north" checked />北を上</label>
    <label><input type="radio" name="orient" value="course" />進行方向を上</label>
  </div>
</div>

<button id="fabStop">停止</button>
<div id="recBadge"><div class="dot"></div>評価中</div>
<div id="toast"></div>

<script src="leaflet.js"></script>
<script src="jszip.min.js"></script>
<script src="togeojson.umd.js"></script>

<script>
const map = L.map('map').setView([35.681,139.767], 13);
L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
  maxZoom: 19, attribution: '&copy; OpenStreetMap contributors'
}).addTo(map);

let routeLayers = [];
const datasetSelect = document.getElementById("datasetSelect");
const toast = document.getElementById("toast");

function showToast(msg){
  toast.textContent = msg;
  toast.style.display = "block";
  setTimeout(()=>toast.style.display="none", 2500);
}

document.getElementById("file").addEventListener("change", async (event) => {
  const files = event.target.files;
  for (const file of files) {
    try {
      const name = file.name.toLowerCase();
      const type = file.type;

      let kmlText = "";

      if (name.endsWith(".kmz") || type.includes("zip") || type.includes("kmz")) {
        const zip = await JSZip.loadAsync(file);
        const kmlFile = Object.keys(zip.files).find(f => f.endsWith(".kml"));
        if (!kmlFile) {
          showToast("KMZ内にKMLファイルが見つかりません。");
          continue;
        }
        kmlText = await zip.files[kmlFile].async("text");
      } else if (name.endsWith(".kml") || type.includes("kml")) {
        kmlText = await file.text();
      } else {
        showToast(`対応していないファイル形式: ${file.name}`);
        continue;
      }

      const parser = new DOMParser();
      const kmlDom = parser.parseFromString(kmlText, "text/xml");
      const geojson = toGeoJSON.kml(kmlDom);
      const layer = L.geoJSON(geojson, {
        style: { color: "orange", weight: 3 },
        pointToLayer: (f, latlng) => L.circleMarker(latlng, { radius: 6, color: "black", fillColor: "blue", fillOpacity: 0.8 })
      }).addTo(map);
      routeLayers.push(layer);
      map.fitBounds(layer.getBounds());
      const option = document.createElement("option");
      option.value = routeLayers.length - 1;
      option.textContent = file.name;
      datasetSelect.appendChild(option);
      showToast(`${file.name} を読み込みました`);
    } catch (err) {
      console.error(err);
      showToast(`読み込み失敗: ${file.name}`);
    }
  }
});

datasetSelect.addEventListener("change", (e)=>{
  const idx = e.target.value;
  if(routeLayers[idx]) map.fitBounds(routeLayers[idx].getBounds());
});

document.getElementById("recenter").addEventListener("click", ()=>{
  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(pos=>{
      map.setView([pos.coords.latitude,pos.coords.longitude],16);
    }, ()=>showToast("現在地を取得できません"));
  }
});

if('serviceWorker' in navigator){
  navigator.serviceWorker.register('./sw.js');
}
</script>
</body>
</html>
